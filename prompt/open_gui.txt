安卓 Java 原生 - OpenCode 语音编程助手开发规范（完整版）
整体说明
本规范为OpenCode 语音编程安卓 APP的完整开发要求，基于 Java 原生开发、适配安卓 8.0+（SDK24）、兼容骁龙 8 系芯片 NNAPI 硬件加速，核心实现按住说话录音、抬手自动转文并发送 OpenCode、上滑取消录音的核心交互，WAV 临时文件全程用完即删。针对无网络梯子无法访问 Hugging Face 的场景，补充模型下载镜像站、多源重试、下载失败自动跳过机制，跳过下载后不阻塞 APP 后续编码 / 初始化，仅禁用录音功能并提示手动放置模型，其余配置功能正常可用，网络请求严格遵循 OpenCode 官方 HTTP API 规范，全流程做好异常处理与状态同步，代码可直接导入 Android Studio 运行。
一、核心业务逻辑全流程
APP 启动→初始化基础功能→Whisper 模型多源下载（原地址 + 镜像站）→下载成功则部署模型，失败则跳过下载→继续初始化 OpenCode 相关配置→录音功能按需禁用（模型未部署则禁用）→核心触摸交互 / 转文 / 发送流程，全流程无阻塞，下载失败仅禁用录音，其余功能（如 OpenCode 地址配置）正常可用，所有耗时操作均在子线程执行，UI 无卡顿 / ANR。
plaintext
APP启动→初始化基础工具类/UI→检测Whisper模型是否存在→├─存在→校验完整性→加载模型→启用录音按钮
                                └─不存在→依次尝试原地址/镜像站下载→├─任一地址下载成功→部署模型→启用录音按钮
                                                                  └─所有地址下载失败→**跳过下载**→吐司提示→禁用录音按钮（不阻塞后续流程）
APP后续流程正常执行：配置OpenCode地址/创建会话等
按住录音按钮(ACTION_DOWN)→启动录音+生成WAV缓存文件→按钮高亮+转圈动画
├─抬手无滑动(ACTION_UP)→停止录音→WAV文件校验→子线程执行Whisper音转文→转文成功→自动调用OpenCode发送消息接口→对话区展示结果→删除WAV文件
│                                  └─转文失败→吐司提示→删除WAV文件
└─按住上滑(位移≥50dp)→触发取消逻辑→立即停止录音→吐司提示→删除WAV文件→按钮显示取消反馈→抬手恢复默认状态
核心新增：模型下载失败后跳过下载步骤，APP 继续向下编码 / 初始化，仅禁用录音功能，OpenCode 配置、界面交互等其余功能完全正常。
二、核心触摸交互逻辑（优先级最高）
无修改，保留原有全部逻辑，仅在模型未部署（下载跳过 / 失败）时，录音按钮为禁用状态，无触摸反馈。
三、录音与文件处理规范
无修改，保留原有全部参数、存储、清理规则。
四、Whisper 音转文实现规范
4.1 模型与硬件加速配置
无修改，保留原有全部硬性配置，强制使用ggml-tiny.en、开启 NNAPI 加速等。
4.2 转文执行要求
无修改，保留原有全部执行与封装要求。
4.3 转文异常处理
无修改，保留原有异常提示与流程终止规则。
4.4 模型自动安装部署（核心适配无梯子场景，新增镜像站 + 下载失败跳过）
4.4.1 核心部署逻辑（多源下载 + 失败跳过 + 不阻塞后续流程）
针对无梯子无法访问 Hugging Face的场景，优化模型部署流程，增加国内可访问镜像站作为备选下载源，原地址下载失败则自动重试镜像站；所有源均下载失败时，直接跳过下载步骤，不阻塞 APP 后续编码 / 初始化，仅禁用录音功能并给出手动放置模型的提示，APP 其余功能（如 OpenCode 地址配置、界面操作）完全正常，后续用户手动放置模型后重启 APP 即可完成部署。
plaintext
APP启动→FileManager检测getFilesDir()/whisper/下是否存在ggml-tiny.en.bin
├─存在→校验文件完整性→完整→直接加载模型+启用录音；不完整→删除破损文件→触发多源下载
└─不存在→触发**多源依次下载**→├─任一源下载成功→拷贝到指定目录→加载模型+启用录音
                              └─所有源下载失败→**跳过下载**→吐司提示手动放置模型→禁用录音按钮→**继续执行APP后续所有初始化流程**（不阻塞编码）
核心新增：下载失败后无卡死 / 无流程中断，直接向下继续编码，仅禁用录音功能。
4.4.2 多源下载地址配置（原地址 + 国内镜像站，均为无梯子可访问）
放弃原 Hugging Face 地址，替换为GitHub 官方源 + 国内 Gitee 镜像源 + 开源 CDN 镜像源，均为无梯子可正常访问的地址，按优先级依次尝试，所有地址定义为全局常量，支持便捷修改 / 新增，无需梯子即可下载。
java
运行
// 优先级1：whisper.cpp GitHub官方仓库（无梯子可访问，原始源）
public static final String WHISPER_MODEL_URL1 = "https://raw.githubusercontent.com/ggerganov/whisper.cpp/master/models/ggml-tiny.en.bin";
// 优先级2：国内Gitee镜像仓库（无梯子，速度快，首选备用）
public static final String WHISPER_MODEL_URL2 = "https://gitee.com/mirrors/whisper.cpp/raw/master/models/ggml-tiny.en.bin";
// 优先级3：国内开源CDN镜像（无梯子，高可用）
public static final String WHISPER_MODEL_URL3 = "https://cdn.jsdelivr.net/gh/ggerganov/whisper.cpp@master/models/ggml-tiny.en.bin";
4.4.3 多源下载执行规则
下载顺序：URL1→URL2→URL3，按优先级依次尝试，任一源下载成功则终止后续重试，进入模型部署步骤；
单源超时：每个下载源的超时时间为15 秒（短超时，避免无意义等待），定义为全局常量；
重试机制：单个源下载失败（超时 / 连接失败 / 断连），不重复重试，直接切换下一个源，减少等待时间。
4.4.4 下载失败跳过机制（核心适配无梯子需求）
跳过触发条件：URL1/URL2/URL3 均下载失败（超时 / 连接拒绝 / 网络异常等）；
跳过后续操作：
立即终止模型下载流程，不抛出异常，不中断 APP 后续任何初始化 / 编码流程；
自动执行吐司提示（内容固定），并禁用录音按钮；
继续执行 APP 后续所有逻辑：OpenCode 地址配置、会话创建、UI 交互等，完全不阻塞编码；
跳过后 APP 状态：
录音按钮：禁用状态（深灰色，无触摸反馈），按钮下方提示 **“模型未部署，请手动放置后重启”**；
配置页：完全正常打开 / 修改 / 保存 OpenCode IP + 端口，无任何限制；
其他功能：界面滚动、消息操作、吐司提示等全部正常；
后续恢复：用户手动将模型文件放入指定目录后，重启 APP 即可自动加载模型，启用录音按钮，无需修改代码。
4.4.5 手动放置模型的兜底方案（无下载 / 下载失败均适用）
提供2 种手动放置方式，用户任选其一，均为无网络 / 无下载条件下的快速部署方案，放入后重启 APP 即自动加载，无需额外操作：
方案 1（工程开发阶段）：将ggml-tiny.en.bin放入工程assets/whisper/目录，APP 重启后自动拷贝到内部存储getFilesDir()/whisper/目录，完成部署；
方案 2（APP 安装后）：通过手机文件管理工具，将模型文件拷贝到 APP 私有目录Android/data/包名/files/whisper/（包名如com.opencode.voiceassist），APP 重启后直接加载。
两种方案均无需梯子、无需下载，拷贝后重启即生效。
4.4.6 部署状态反馈（新增跳过下载的提示）
在原有反馈基础上，新增多源下载 / 跳过下载的专属提示，所有提示均为吐司轻提示，不遮挡界面：
多源下载中：正在下载模型(1/3)...→正在下载模型(2/3)...（依次显示优先级）；
单源下载失败：无单独提示，直接切换下一个源；
所有源下载失败 / 跳过下载：模型下载失败，已跳过！请手动放置模型后重启APP（持续显示 3 秒，醒目提示）；
手动放置后重启成功：模型部署成功，录音功能已启用；
其他原有提示（部署成功 / 文件破损等）保留。
五、OpenCode HTTP API 完整调用规范
无修改，保留原有全部接口、请求 / 响应格式、会话复用、网络配置要求。
补充：模型下载跳过 / 失败后，OpenCode 会话创建流程正常执行，若 OpenCode 地址配置正确则创建成功，仅因录音禁用无法发送消息；地址配置错误则正常提示，无任何流程阻塞。
六、结果展示与消息操作规范
无修改，保留原有全部展示、样式、语法高亮、消息操作要求。
七、UI 界面设计与交互反馈
7.1-7.4 顶部标题栏 / 对话区 / 底部交互栏 / 配置页
无修改，保留原有全部布局与功能，仅对底部语音交互栏的录音按钮提示做小幅调整。
7.5 视觉反馈与提示规范
7.5.1 录音按钮状态（补充跳过下载后的禁用提示）
保留原有 5 种状态，仅禁用状态的提示文字做精准适配，区分不同禁用原因，用户可快速定位问题：
默认状态：灰色底色，无动画，无文字；
按住录音状态：高亮蓝色底色，顺时针转圈加载动画，无文字；
上滑取消状态：浅红色底色，显示 “取消” 白色文字，无动画；
转文 / 发送中状态：浅灰色底色，顺时针转圈加载动画，无文字；
禁用状态：深灰色底色，无动画，无文字，按钮下方提示文字按禁用原因区分：
模型下载失败 / 跳过：模型未部署，请手动放置后重启；
OpenCode 会话创建失败：OpenCode连接失败，请检查配置；
权限未开启：请开启录音/网络权限后使用。
7.5.2 吐司提示规范（新增 3 条专属提示）
保留原有提示样式 / 时长 / 位置，新增 3 条无梯子场景的专属提示语，固定不变：
多源下载中：正在下载模型(1/3).../正在下载模型(2/3).../正在下载模型(3/3)...；
所有源下载失败跳过：模型下载失败，已跳过！请手动放置模型后重启APP；
手动放置模型重启成功：模型部署成功，录音功能已启用。
原有所有提示语保留，无修改。
八、技术实现硬性要求
8.1-8.3 开发语言 / 权限处理 / 异步处理
无修改，保留原有全部要求，补充异步处理新增要求：
模型多源下载的源切换逻辑、下载失败判断、跳过下载执行，均在子线程完成，不涉及 UI 线程，确保 APP 界面流畅无卡顿。
8.4 代码封装规范
无修改，保留原有工具类拆分要求，仅对WhisperManager和FileManager做小幅扩展：
WhisperManager：新增多源下载地址管理、源切换逻辑、下载失败跳过判断方法；
FileManager：新增模型文件路径校验方法，兼容手动放置的 2 种方案路径。
8.5 常量集中管理（核心新增多源地址 + 跳过相关配置）
在原有 Constant 类基础上，新增无梯子场景的核心常量，所有可配置参数集中管理，支持便捷修改，无硬编码：
java
运行
// 模型多源下载地址（无梯子可访问，按优先级排序）
public static final String WHISPER_MODEL_URL1 = "https://raw.githubusercontent.com/ggerganov/whisper.cpp/master/models/ggml-tiny.en.bin";
public static final String WHISPER_MODEL_URL2 = "https://gitee.com/mirrors/whisper.cpp/raw/master/models/ggml-tiny.en.bin";
public static final String WHISPER_MODEL_URL3 = "https://cdn.jsdelivr.net/gh/ggerganov/whisper.cpp@master/models/ggml-tiny.en.bin";
// 多源下载配置（无梯子适配）
public static final int MODEL_SINGLE_TIMEOUT = 15; // 单源下载超时时间(s)，短超时避免等待
public static final String[] WHISPER_MODEL_URLS = {WHISPER_MODEL_URL1, WHISPER_MODEL_URL2, WHISPER_MODEL_URL3}; // 下载源数组，方便遍历
// 跳过下载后提示语
public static final String TOAST_MODEL_DOWNLOAD_SKIP = "模型下载失败，已跳过！请手动放置模型后重启APP";
原有所有常量保留，无修改。
8.6 全流程异常捕获（新增下载跳过的异常处理）
新增 2 类无梯子场景的异常捕获，均为非致命异常，捕获后仅提示 + 禁用录音，不崩溃、不阻塞流程：
所有下载源连接失败异常：捕获后执行跳过下载逻辑，提示并禁用录音；
下载源超时异常：单个源超时后直接切换下一个源，所有源超时则执行跳过逻辑；
原有所有异常捕获场景保留，无修改。
九、工程输出标准
9.1 工程结构完整
无修改，保留原有全部目录结构，仅在assets/whisper/目录下新增一个 README.txt 文件，内容为手动放置模型的操作说明，方便用户快速查看：
txt
ggml-tiny.en.bin 模型文件放置目录
无梯子下载失败时，将模型文件放入此目录，重启APP即可自动部署
模型下载地址：
1. GitHub: https://raw.githubusercontent.com/ggerganov/whisper.cpp/master/models/ggml-tiny.en.bin
2. Gitee: https://gitee.com/mirrors/whisper.cpp/raw/master/models/ggml-tiny.en.bin
9.2 依赖配置精准
无修改，保留原有全部必要依赖，无新增冗余依赖。
9.3 注释与文档完整
新增无梯子场景的专属注释与文档，其余保留：
代码注释：在WhisperManager的模型下载方法中，对多源切换、失败跳过、手动放置路径做详细注释；
工程使用说明：新增 **「无梯子场景模型部署指南」** 章节，包含镜像站地址、手动放置 2 种方法、跳过下载后的 APP 状态说明；
常见问题排查：新增 **「模型下载失败 / 无法访问 Hugging Face」** 排查项，直接指向手动放置模型的解决方案。
9.4 无冗余代码与文件
无修改，保留原有全部要求。
十、额外要求
新增 2 条无梯子场景的适配要求，其余保留：
模型下载流程支持手动中断：APP 启动后若发现下载速度慢，可直接退出 APP，重启后将直接检测模型不存在并重新触发多源下载，或用户直接手动放置模型跳过下载；
工程打包时不包含任何模型文件：assets/whisper/目录仅保留 README.txt，不包含 ggml-tiny.en.bin，减小 APK 安装包体积，用户可根据自身情况手动放置。